# Travis configuration
#
# Note: building Fortran code is not supported (yet): see https://docs.travis-ci.com/user/language-specific/
#       this is using C as a base and installs gfortran in the test environment
language: c

sudo: required

os: linux
compiler: gcc

env:
  global:
  - FC=gfortran
  - MPIFC=mpif90
  - CC=gcc
  - OMP_NUM_THREADS=2
  matrix:
  - TEST="" TESTCOV=0
  - TEST="--enable-debug" TESTCOV=0
  - TEST="--enable-vectorization" TESTCOV=0
  - TEST="--enable-vectorization --enable-openmp" TESTCOV=0
  - TEST="--enable-openmp" TESTFLAGS="FLAGS_CHECK=\"-fprofile-arcs -ftest-coverage -O0\""

before_install:
  # recommended for MPI projects to unset CC: see https://docs.travis-ci.com/user/languages/c
  #- test -n $CC && unset CC
  - sudo apt-get update

install:
  - sudo apt-get install gfortran libgomp1 openmpi-bin libopenmpi-dev
  - echo "compiler versions:" ${FC} ${MPIFC} ${CC}
  - ${FC} --version
  - ${MPIFC} --version
  - ${CC} --version

script:
  - echo "configuration test:" ${TEST} ${TESTFLAGS}
  # test configuration
  - if [ "$TESTCOV" == "1" ]; then
      ./configure FC=${FC} MPIFC=${MPIFC} CC=${CC} ${TEST} FLAGS_CHECK="-fprofile-arcs -ftest-coverage -O0"
    else
      ./configure FC=${FC} MPIFC=${MPIFC} CC=${CC} ${TEST}
    fi
  - make clean
  # test small example
  - cd EXAMPLES/regional_Greece_small/
  - sed -i "s:^RECORD_LENGTH_IN_MINUTES .*:RECORD_LENGTH_IN_MINUTES = 0.1:" DATA/Par_file
  - ./run_this_example.sh
  # report example
  - if [ -f OUTPUT_FILES/output_mesher.txt ]; then cat OUTPUT_FILES/output_mesher.txt; fi
  - if [ -f OUTPUT_FILES/output_solver.txt ]; then cat OUTPUT_FILES/output_solver.txt; fi

# runs example
after_success:
  # code coverage: see example https://github.com/codecov/example-fortran/blob/master/.travis.yml
  - if [ "$TESTCOV" == "1" ]; then bash <(curl -s https://codecov.io/bash) -s obj/; fi
